<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
        }
        .cancelled-order {
            opacity: 0.7;
            background-color: #f8f9fa;
        }
        .order-card {
            transition: all 0.3s;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .star-rating {
            font-size: 1.5rem;
            cursor: pointer;
        }
        .star-rating .star {
            color: #ddd;
            transition: color 0.2s;
        }
        .star-rating .star:hover,
        .star-rating .star.active {
            color: #ffc107;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .restaurant-item:hover {
            background-color: #f8f9fa;
        }
        .pagination-container {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">üë§ Client - {{ username }}</span>
            <div class="d-flex">
                <span class="navbar-text me-3" id="connectionStatus">üü¢ Connect√©</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">D√©connexion</a>
            </div>
        </div>
    </nav>

    <div class="notification-container" id="notificationContainer"></div>

    <!-- Order Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üõí Passer une commande</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="step active" id="step1">
                        <h6>√âtape 1: Choisissez un restaurant</h6>
                        
                        <!-- Search Bar -->
                        <div class="mb-3">
                            <input type="text" class="form-control" id="restaurantSearch" 
                                   placeholder="Rechercher un restaurant..." onkeyup="filterRestaurants()">
                        </div>
                        
                        <div id="restaurantListSpinner" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                        
                        <div id="restaurantListContainer"></div>
                        
                        <!-- Pagination Controls -->
                        <nav id="paginationControls" class="pagination-container" style="display: none;">
                            <ul class="pagination justify-content-center">
                                <li class="page-item">
                                    <button class="page-link" id="prevPage">Pr√©c√©dent</button>
                                </li>
                                <li class="page-item">
                                    <span class="page-link text-muted" id="pageInfo">Page 1</span>
                                </li>
                                <li class="page-item">
                                    <button class="page-link" id="nextPage">Suivant</button>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <div class="step" id="step2">
                        <h6 id="menuTitle">√âtape 2: Choisissez vos articles</h6>
                        <div id="menuListSpinner" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                        <div id="menuListContainer"></div>
                    </div>

                    <div class="step" id="step3">
                        <h6>√âtape 3: R√©capitulatif</h6>
                        <p><strong>Restaurant:</strong> <span id="summaryRestaurant"></span></p>
                        <strong>Articles:</strong>
                        <ul id="summaryItems" class="list-group list-group-flush mb-3"></ul>
                        <h5 class="text-end">Total: <span id="summaryTotal" class="text-success">0.00 ‚Ç¨</span></h5>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btnPrev" style="display: none;">Pr√©c√©dent</button>
                    <button type="button" class="btn btn-primary" id="btnNext" disabled>Suivant</button>
                    <button type="button" class="btn btn-success" id="btnSubmitOrder" style="display: none;">
                        Confirmer la commande
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ratingModalTitle">Noter votre livreur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="ratingContent">
                        <p>Comment √©tait votre exp√©rience de livraison ?</p>
                        <div class="star-rating text-center mb-3" id="starRating">
                            <span class="star" data-rating="1">‚òÜ</span>
                            <span class="star" data-rating="2">‚òÜ</span>
                            <span class="star" data-rating="3">‚òÜ</span>
                            <span class="star" data-rating="4">‚òÜ</span>
                            <span class="star" data-rating="5">‚òÜ</span>
                        </div>
                        <div class="text-center">
                            <small class="text-muted" id="ratingText">S√©lectionnez une note</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submitRating" disabled>Envoyer la note</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">Mes Commandes</h4>
                            <small class="text-muted">Vous pouvez annuler une commande tant qu'aucun livreur n'est assign√©</small>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderModal">
                            üõí Passer une commande
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="ordersList">
                            {% for order in orders %}
                            <div class="card order-card mb-3 
                                {% if order.status == 'cancelled' %}cancelled-order{% endif %}" 
                                id="order-{{ order.id }}">
                                
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong>Commande #{{ order.id }}</strong>
                                                    <br>
                                                    <span class="text-muted">{{ order.articles }}</span>
                                                    <br>
                                                    <small class="text-muted">
                                                        Restaurant: {{ order.restaurant_name | default(order.restaurant) }}
                                                        {% if order.assigned_driver %}
                                                        <br>Livreur: {{ order.assigned_driver }}
                                                        {% endif %}
                                                        {% if order.client_rating %}
                                                        <br>Votre note: 
                                                        <span class="text-warning">
                                                            {% for i in range(5) %}
                                                                {% if i < order.client_rating|int %}‚≠ê{% else %}‚òÜ{% endif %}
                                                            {% endfor %}
                                                            ({{ order.client_rating }}/5)
                                                        </span>
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge 
                                                        {% if order.status == 'pending' %}bg-secondary
                                                        {% elif order.status == 'ready' %}bg-warning
                                                        {% elif order.status == 'assigned' %}bg-info
                                                        {% elif order.status == 'delivered' %}bg-success
                                                        {% elif order.status == 'cancelled' %}bg-danger
                                                        {% else %}bg-dark{% endif %}">
                                                        {{ order.status }}
                                                    </span>
                                                    <br>
                                                    <small class="text-muted" title="{{ order.created_at }}">
                                                        {{ order.created_at.split('T')[0] if order.created_at else '' }}
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            {% if order.status in ['pending', 'ready'] %}
                                            <div class="mt-3">
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="annulerCommande('{{ order.id }}')"
                                                        id="btn-cancel-{{ order.id }}">
                                                    ‚ùå Annuler la commande
                                                </button>
                                                <small class="text-muted ms-2">
                                                    Vous pouvez annuler tant qu'aucun livreur n'est assign√©
                                                </small>
                                            </div>
                                            {% elif order.status == 'assigned' %}
                                            <div class="mt-2">
                                                <small class="text-warning">
                                                    ‚ö†Ô∏è Impossible d'annuler: un livreur a √©t√© assign√©
                                                </small>
                                            </div>
                                            {% elif order.status == 'delivered' and not order.client_rating %}
                                            <div class="mt-3">
                                                <button class="btn btn-outline-warning btn-sm" 
                                                        onclick="noterLivreur('{{ order.id }}', '{{ order.assigned_driver | replace("'", "\\'") }}')">
                                                    ‚≠ê Noter le livreur
                                                </button>
                                                <small class="text-muted ms-2">
                                                    Aidez-nous √† am√©liorer notre service
                                                </small>
                                            </div>
                                            {% elif order.status == 'cancelled' %}
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    ‚ùå Commande annul√©e
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <h5>üì≠ Aucune commande</h5>
                                <p>Cliquez sur "Passer une commande" pour commencer</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h6>‚ÑπÔ∏è Instructions</h6>
                    </div>
                    <div class="card-body">
                        <small>
                            <strong>Statuts des commandes:</strong><br>
                            ‚Ä¢ <span class="badge bg-secondary">pending</span> : En attente du restaurant<br>
                            ‚Ä¢ <span class="badge bg-warning">ready</span> : Pr√™te √† √™tre livr√©e<br>
                            ‚Ä¢ <span class="badge bg-info">assigned</span> : Livreur assign√© (annulation impossible)<br>
                            ‚Ä¢ <span class="badge bg-success">delivered</span> : Livr√©e<br>
                            ‚Ä¢ <span class="badge bg-danger">cancelled</span> : Annul√©e<br>
                            <br>
                            <strong>Notation:</strong> Vous pouvez noter le livreur apr√®s chaque livraison.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let eventSource = null;
        let currentRatingOrderId = null;
        let currentRatingDriverId = null;
        let selectedRating = 0;
        
        // Order modal variables
        let orderModal = null;
        let currentStep = 1;
        let selectedRestaurant = { id: null, name: null };
        let selectedMenu = {};
        let cart = {};
        
        // Pagination variables
        let currentPage = 1;
        let allRestaurants = [];
        let filteredRestaurants = [];
        let isSearching = false;

        document.addEventListener('DOMContentLoaded', function() {
            orderModal = new bootstrap.Modal(document.getElementById('orderModal'));

            // Handle modal opening
            document.getElementById('orderModal').addEventListener('show.bs.modal', function () {
                resetOrderModal();
                loadRestaurants(1);
            });

            // Handle modal navigation buttons
            document.getElementById('btnNext').addEventListener('click', nextStep);
            document.getElementById('btnPrev').addEventListener('click', prevStep);
            
            // Handle order submission
            document.getElementById('btnSubmitOrder').addEventListener('click', submitOrder);
            
            // Initialize rating system and SSE
            initRatingSystem();
            connectToEvents();
        });

        function resetOrderModal() {
            currentStep = 1;
            currentPage = 1;
            selectedRestaurant = { id: null, name: null };
            selectedMenu = {};
            cart = {};
            isSearching = false;
            
            // Reset search
            document.getElementById('restaurantSearch').value = '';
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
            
            document.getElementById('btnPrev').style.display = 'none';
            document.getElementById('btnSubmitOrder').style.display = 'none';
            document.getElementById('btnNext').style.display = 'block';
            document.getElementById('btnNext').disabled = true;
            
            document.getElementById('restaurantListContainer').innerHTML = '';
            document.getElementById('menuListContainer').innerHTML = '';
            document.getElementById('paginationControls').style.display = 'none';
        }

        function loadRestaurants(page = 1) {
            currentPage = page;
            document.getElementById('restaurantListSpinner').style.display = 'block';
            document.getElementById('restaurantListContainer').innerHTML = '';
            document.getElementById('paginationControls').style.display = 'none';
            
            fetch(`/get_restaurants_paginated?page=${page}&per_page=10`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('restaurantListSpinner').style.display = 'none';
                    
                    if (data.status === 'success') {
                        displayRestaurants(data.restaurants);
                        updatePaginationControls(data.pagination);
                    } else {
                        showRestaurantError('Impossible de charger les restaurants.');
                    }
                })
                .catch(err => {
                    document.getElementById('restaurantListSpinner').style.display = 'none';
                    showRestaurantError('Erreur de connexion.');
                });
        }

        function displayRestaurants(restaurants) {
            const container = document.getElementById('restaurantListContainer');
            
            if (restaurants.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Aucun restaurant trouv√©.</div>';
                return;
            }
            
            container.innerHTML = '<div class="list-group"></div>';
            restaurants.forEach(resto => {
                container.firstElementChild.innerHTML += `
                    <a href="#" class="list-group-item list-group-item-action restaurant-item" 
                       data-id="${resto.id}" data-name="${resto.name}"
                       onclick="selectRestaurant(this, '${resto.id}', '${resto.name.replace(/'/g, "\\'")}')">
                        ${resto.name}
                    </a>
                `;
            });
        }

        function updatePaginationControls(pagination) {
            const controls = document.getElementById('paginationControls');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');
            
            pageInfo.textContent = `Page ${pagination.page} / ${pagination.total_pages}`;
            
            prevBtn.disabled = !pagination.has_prev;
            nextBtn.disabled = !pagination.has_next;
            
            prevBtn.onclick = () => pagination.has_prev && loadRestaurants(pagination.page - 1);
            nextBtn.onclick = () => pagination.has_next && loadRestaurants(pagination.page + 1);
            
            controls.style.display = 'block';
        }

        function showRestaurantError(message) {
            document.getElementById('restaurantListContainer').innerHTML = 
                `<div class="alert alert-danger">${message}</div>`;
        }

        function filterRestaurants() {
            const searchTerm = document.getElementById('restaurantSearch').value.toLowerCase();
            
            if (searchTerm.length === 0) {
                // If no search term, reload paginated data
                isSearching = false;
                loadRestaurants(currentPage);
                return;
            }
            
            isSearching = true;
            document.getElementById('restaurantListSpinner').style.display = 'block';
            document.getElementById('restaurantListContainer').innerHTML = '';
            document.getElementById('paginationControls').style.display = 'none';
            
            // Load all restaurants for searching
            fetch('/get_restaurants')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('restaurantListSpinner').style.display = 'none';
                    
                    if (data.status === 'success') {
                        const filtered = data.restaurants.filter(resto => 
                            resto.name.toLowerCase().includes(searchTerm)
                        );
                        
                        if (filtered.length === 0) {
                            document.getElementById('restaurantListContainer').innerHTML = 
                                '<div class="alert alert-info">Aucun restaurant ne correspond √† votre recherche.</div>';
                        } else {
                            displayRestaurants(filtered.slice(0, 20)); // Show first 20 results
                        }
                    } else {
                        showRestaurantError('Impossible de charger les restaurants.');
                    }
                })
                .catch(err => {
                    document.getElementById('restaurantListSpinner').style.display = 'none';
                    showRestaurantError('Erreur lors de la recherche.');
                });
        }

        function selectRestaurant(element, id, name) {
            // Handle visual selection
            document.querySelectorAll('#restaurantListContainer .restaurant-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            selectedRestaurant = { id, name };
            document.getElementById('btnNext').disabled = false;
        }

        function loadMenu() {
            document.getElementById('menuListSpinner').style.display = 'block';
            document.getElementById('menuListContainer').innerHTML = '';
            
            fetch(`/get_menu/${selectedRestaurant.id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('menuListSpinner').style.display = 'none';
                    if (data.status === 'success') {
                        selectedMenu = data.menu;
                        const container = document.getElementById('menuListContainer');
                        container.innerHTML = '<ul class="list-group"></ul>';
                        
                        for (const [item, price] of Object.entries(data.menu)) {
                            container.firstElementChild.innerHTML += `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${item}</strong><br>
                                        <small class="text-muted">${price.toFixed(2)} ‚Ç¨</small>
                                    </div>
                                    <input type="number" class="form-control" style="width: 100px;" 
                                           min="0" value="0" data-item="${item}" data-price="${price}"
                                           onchange="updateCart(this)">
                                </li>
                            `;
                        }
                    } else {
                        document.getElementById('menuListContainer').innerHTML = '<div class="alert alert-danger">Impossible de charger le menu.</div>';
                    }
                })
                .catch(err => {
                    document.getElementById('menuListSpinner').style.display = 'none';
                    document.getElementById('menuListContainer').innerHTML = '<div class="alert alert-danger">Erreur de connexion.</div>';
                });
        }
        
        function updateCart(input) {
            const item = input.dataset.item;
            const price = parseFloat(input.dataset.price);
            const quantity = parseInt(input.value);
            
            if (quantity > 0) {
                cart[item] = { quantity, price };
            } else {
                delete cart[item];
            }
            
            // Enable Next button if at least 1 item is selected
            document.getElementById('btnNext').disabled = Object.keys(cart).length === 0;
        }
        
        function showSummary() {
            document.getElementById('summaryRestaurant').textContent = selectedRestaurant.name;
            const itemsContainer = document.getElementById('summaryItems');
            itemsContainer.innerHTML = '';
            let total = 0;
            
            for (const [item, data] of Object.entries(cart)) {
                itemsContainer.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between">
                        <span>${data.quantity} x ${item}</span>
                        <span>${(data.quantity * data.price).toFixed(2)} ‚Ç¨</span>
                    </li>
                `;
                total += data.quantity * data.price;
            }
            
            document.getElementById('summaryTotal').textContent = `${total.toFixed(2)} ‚Ç¨`;
        }
        
        function submitOrder() {
            const orderData = {
                restaurant_id: selectedRestaurant.id,
                items: Object.entries(cart).map(([item, data]) => ({
                    item: item,
                    quantity: data.quantity,
                    price: data.price
                }))
            };
            
            document.getElementById('btnSubmitOrder').disabled = true;
            document.getElementById('btnSubmitOrder').innerHTML = `
                <span class="spinner-border spinner-border-sm"></span> Envoi...
            `;
            
            fetch('/passer_commande', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    orderModal.hide();
                    showNotification(`‚úÖ Commande #${data.order_id} pass√©e avec succ√®s!`, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('‚ùå Erreur: ' + (data.message || 'Impossible de passer commande'), 'danger');
                }
            })
            .catch(error => {
                showNotification('‚ùå Erreur de connexion', 'danger');
                console.error('Erreur:', error);
            })
            .finally(() => {
                document.getElementById('btnSubmitOrder').disabled = false;
                document.getElementById('btnSubmitOrder').innerHTML = 'Confirmer la commande';
            });
        }

        function nextStep() {
            if (currentStep === 1) {
                currentStep = 2;
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                document.getElementById('btnPrev').style.display = 'inline-block';
                document.getElementById('btnNext').disabled = true;
                document.getElementById('menuTitle').textContent = `√âtape 2: Menu de ${selectedRestaurant.name}`;
                loadMenu();
            } else if (currentStep === 2) {
                currentStep = 3;
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3').classList.add('active');
                document.getElementById('btnNext').style.display = 'none';
                document.getElementById('btnSubmitOrder').style.display = 'inline-block';
                showSummary();
            }
        }

        function prevStep() {
            if (currentStep === 2) {
                currentStep = 1;
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step1').classList.add('active');
                document.getElementById('btnPrev').style.display = 'none';
                document.getElementById('btnNext').disabled = false;
            } else if (currentStep === 3) {
                currentStep = 2;
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                document.getElementById('btnNext').style.display = 'inline-block';
                document.getElementById('btnSubmitOrder').style.display = 'none';
                document.getElementById('btnNext').disabled = Object.keys(cart).length === 0;
            }
        }
        
        function annulerCommande(orderId) {
            if (!confirm(`√ätes-vous s√ªr de vouloir annuler la commande #${orderId} ?`)) {
                return;
            }
            
            fetch(`/annuler_commande/${orderId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification(`‚úÖ Commande #${orderId} annul√©e avec succ√®s`, 'success');
                        updateOrderStatus(orderId, 'cancelled');
                    } else {
                        showNotification('‚ùå Erreur: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    showNotification('‚ùå Erreur de connexion', 'danger');
                    console.error('Erreur:', error);
                });
        }
        
        function noterLivreur(orderId, driverId) {
            currentRatingOrderId = orderId;
            currentRatingDriverId = driverId;
            selectedRating = 0;
            
            // Reset stars
            document.querySelectorAll('#starRating .star').forEach(star => {
                star.classList.remove('active');
                star.textContent = '‚òÜ';
            });
            
            document.getElementById('ratingText').textContent = 'S√©lectionnez une note';
            document.getElementById('submitRating').disabled = true;
            
            // Update modal title
            document.getElementById('ratingModalTitle').textContent = `Noter ${driverId}`;
            
            // Show modal
            const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
            ratingModal.show();
        }
        
        function updateOrderStatus(orderId, newStatus) {
            const orderElement = document.getElementById(`order-${orderId}`);
            if (!orderElement) return;
            
            // Update status badge
            const statusBadge = orderElement.querySelector('.badge');
            if (statusBadge) {
                statusBadge.textContent = newStatus;
                statusBadge.className = 'badge ' + (
                    newStatus === 'pending' ? 'bg-secondary' :
                    newStatus === 'ready' ? 'bg-warning' :
                    newStatus === 'assigned' ? 'bg-info' :
                    newStatus === 'delivered' ? 'bg-success' :
                    newStatus === 'cancelled' ? 'bg-danger' : 'bg-dark'
                );
            }
            
            // Update actions
            const actionDiv = orderElement.querySelector('.mt-3') || orderElement.querySelector('.mt-2');
            if (actionDiv) {
                if (newStatus === 'cancelled') {
                    actionDiv.innerHTML = '<small class="text-muted">‚ùå Commande annul√©e</small>';
                    orderElement.classList.add('cancelled-order');
                } else if (newStatus === 'assigned') {
                    actionDiv.innerHTML = '<small class="text-warning">‚ö†Ô∏è Impossible d\'annuler: un livreur a √©t√© assign√©</small>';
                } else if (newStatus === 'delivered') {
                    // Reload page to show rating button
                    location.reload();
                }
            }
        }
        
        // Initialize rating system
        function initRatingSystem() {
            // Handle star clicks
            document.querySelectorAll('#starRating .star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    selectedRating = rating;
                    
                    // Update star display
                    document.querySelectorAll('#starRating .star').forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                            s.textContent = '‚≠ê';
                        } else {
                            s.classList.remove('active');
                            s.textContent = '‚òÜ';
                        }
                    });
                    
                    // Update text
                    const ratingTexts = [
                        'M√©diocre',
                        'Passable', 
                        'Bien',
                        'Tr√®s bien',
                        'Excellent'
                    ];
                    document.getElementById('ratingText').textContent = ratingTexts[rating - 1];
                    document.getElementById('submitRating').disabled = false;
                });
            });
            
            // Submit rating
            document.getElementById('submitRating').addEventListener('click', function() {
                if (selectedRating === 0) return;
                
                fetch(`/noter_livreur/${currentRatingOrderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ note: selectedRating })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification(data.message, 'success');
                        
                        // Close modal
                        const ratingModal = bootstrap.Modal.getInstance(document.getElementById('ratingModal'));
                        ratingModal.hide();
                        
                        // Reload page to display rating
                        location.reload();
                        
                    } else {
                        showNotification('‚ùå Erreur: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    showNotification('‚ùå Erreur de connexion', 'danger');
                    console.error('Erreur:', error);
                });
            });
        }
        
        // Connect to real-time events
        function connectToEvents() {
            eventSource = new EventSource('/events');
            
            eventSource.onopen = function() {
                document.getElementById('connectionStatus').textContent = 'üü¢ Connect√©';
                document.getElementById('connectionStatus').className = 'navbar-text me-3 text-success';
            };
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('√âv√©nement re√ßu:', data);
                
                // Only process events relevant to this user
                const myOrderElement = document.getElementById(`order-${data.data.order_id}`);
                
                if (myOrderElement || (data.type === 'order_created' && data.data.details.client === '{{ username }}')) {
                    switch(data.type) {
                        case 'order_ready':
                            showNotification(`üè™ Commande #${data.data.order_id} est pr√™te!`, 'info');
                            updateOrderStatus(data.data.order_id, 'ready');
                            break;
                        case 'driver_assigned':
                            showNotification(`üö¥ Livreur assign√© √† la commande #${data.data.order_id}`, 'info');
                            updateOrderStatus(data.data.order_id, 'assigned');
                            break;
                        case 'auto_assignment':
                            showNotification(`ü§ñ Livreur automatiquement assign√© √† la commande #${data.data.order_id}`, 'info');
                            updateOrderStatus(data.data.order_id, 'assigned');
                            break;
                        case 'order_delivered':
                            showNotification(`‚úÖ Commande #${data.data.order_id} livr√©e! Vous pouvez noter le livreur.`, 'success');
                            updateOrderStatus(data.data.order_id, 'delivered');
                            break;
                        case 'order_cancelled':
                            showNotification(`‚ùå Votre commande #${data.data.order_id} a √©t√© annul√©e`, 'warning');
                            updateOrderStatus(data.data.order_id, 'cancelled');
                            break;
                        case 'driver_rated':
                            if (data.data.client === '{{ username }}') {
                                showNotification(`‚≠ê Merci d'avoir not√© ${data.data.driver_id}!`, 'success');
                            }
                            break;
                    }
                }
            };
            
            eventSource.onerror = function(event) {
                document.getElementById('connectionStatus').textContent = 'üî¥ D√©connect√©';
                document.getElementById('connectionStatus').className = 'navbar-text me-3 text-danger';
                
                console.log('Erreur SSE, reconnexion...');
                setTimeout(connectToEvents, 5000);
            };
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.getElementById('notificationContainer').appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
        
    </script>
</body>
</html>
