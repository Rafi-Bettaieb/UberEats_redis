<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        .cancelled-order {
            opacity: 0.7;
            background-color: #f8f9fa;
        }
        .order-card {
            transition: all 0.3s;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">üë§ Client - {{ username }}</span>
            <div class="d-flex">
                <span class="navbar-text me-3" id="connectionStatus">üü¢ Connect√©</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">D√©connexion</a>
            </div>
        </div>
    </nav>

    <!-- Container pour les notifications -->
    <div class="notification-container" id="notificationContainer"></div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">Mes Commandes</h4>
                            <small class="text-muted">Vous pouvez annuler une commande tant qu'aucun livreur n'est assign√©</small>
                        </div>
                        <button class="btn btn-primary" onclick="passerCommande()">
                            üõí Passer une commande
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="ordersList">
                            {% for order in orders %}
                            <div class="card order-card mb-3 
                                {% if order.status == 'cancelled' %}cancelled-order{% endif %}" 
                                id="order-{{ order.id }}">
                                
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong>Commande #{{ order.id }}</strong>
                                                    <br>
                                                    <span class="text-muted">{{ order.articles }}</span>
                                                    <br>
                                                    <small class="text-muted">
                                                        Restaurant: {{ order.restaurant }}
                                                        {% if order.assigned_driver %}
                                                        <br>Livreur: {{ order.assigned_driver }}
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge 
                                                        {% if order.status == 'pending' %}bg-secondary
                                                        {% elif order.status == 'ready' %}bg-warning
                                                        {% elif order.status == 'assigned' %}bg-info
                                                        {% elif order.status == 'delivered' %}bg-success
                                                        {% elif order.status == 'cancelled' %}bg-danger
                                                        {% else %}bg-dark{% endif %}">
                                                        {{ order.status }}
                                                    </span>
                                                    <br>
                                                    <small class="text-muted">
                                                        {{ order.created_at if order.created_at else '' }}
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <!-- Bouton d'annulation -->
                                            {% if order.status in ['pending', 'ready'] %}
                                            <div class="mt-3">
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="annulerCommande('{{ order.id }}')"
                                                        id="btn-cancel-{{ order.id }}">
                                                    ‚ùå Annuler la commande
                                                </button>
                                                <small class="text-muted ms-2">
                                                    Vous pouvez annuler tant qu'aucun livreur n'est assign√©
                                                </small>
                                            </div>
                                            {% elif order.status == 'assigned' %}
                                            <div class="mt-2">
                                                <small class="text-warning">
                                                    ‚ö†Ô∏è Impossible d'annuler: un livreur a √©t√© assign√©
                                                </small>
                                            </div>
                                            {% elif order.status == 'cancelled' %}
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    ‚ùå Commande annul√©e
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <h5>üì≠ Aucune commande</h5>
                                <p>Cliquez sur "Passer une commande" pour commencer</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6>‚ÑπÔ∏è Instructions</h6>
                    </div>
                    <div class="card-body">
                        <small>
                            <strong>Statuts des commandes:</strong><br>
                            ‚Ä¢ <span class="badge bg-secondary">pending</span> : En attente du restaurant<br>
                            ‚Ä¢ <span class="badge bg-warning">ready</span> : Pr√™te √† √™tre livr√©e<br>
                            ‚Ä¢ <span class="badge bg-info">assigned</span> : Livreur assign√© (annulation impossible)<br>
                            ‚Ä¢ <span class="badge bg-success">delivered</span> : Livr√©e<br>
                            ‚Ä¢ <span class="badge bg-danger">cancelled</span> : Annul√©e<br>
                            <br>
                            <strong>Annulation:</strong> Possible uniquement avant l'assignation d'un livreur.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        
        function passerCommande() {
            fetch('/passer_commande', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification(`‚úÖ Commande #${data.order_id} pass√©e avec succ√®s!`, 'success');
                        // Rafra√Æchir la liste apr√®s un court d√©lai
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification('‚ùå Erreur: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    showNotification('‚ùå Erreur de connexion', 'danger');
                    console.error('Erreur:', error);
                });
        }
        
        function annulerCommande(orderId) {
            if (!confirm(`√ätes-vous s√ªr de vouloir annuler la commande #${orderId} ?`)) {
                return;
            }
            
            fetch(`/annuler_commande/${orderId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification(`‚úÖ Commande #${orderId} annul√©e avec succ√®s`, 'success');
                        updateOrderStatus(orderId, 'cancelled');
                    } else {
                        showNotification('‚ùå Erreur: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    showNotification('‚ùå Erreur de connexion', 'danger');
                    console.error('Erreur:', error);
                });
        }
        
        function updateOrderStatus(orderId, newStatus) {
            const orderElement = document.getElementById(`order-${orderId}`);
            if (!orderElement) return;
            
            // Mettre √† jour le badge de statut
            const statusBadge = orderElement.querySelector('.badge');
            if (statusBadge) {
                statusBadge.textContent = newStatus;
                statusBadge.className = 'badge ' + (
                    newStatus === 'pending' ? 'bg-secondary' :
                    newStatus === 'ready' ? 'bg-warning' :
                    newStatus === 'assigned' ? 'bg-info' :
                    newStatus === 'delivered' ? 'bg-success' :
                    newStatus === 'cancelled' ? 'bg-danger' : 'bg-dark'
                );
            }
            
            // Mettre √† jour le bouton d'annulation
            const cancelButton = document.getElementById(`btn-cancel-${orderId}`);
            if (cancelButton) {
                if (newStatus === 'cancelled') {
                    cancelButton.remove();
                    orderElement.classList.add('cancelled-order');
                    
                    // Ajouter le message d'annulation
                    const cancelMessage = document.createElement('div');
                    cancelMessage.className = 'mt-2';
                    cancelMessage.innerHTML = '<small class="text-muted">‚ùå Commande annul√©e</small>';
                    orderElement.querySelector('.card-body').appendChild(cancelMessage);
                } else if (newStatus === 'assigned') {
                    cancelButton.remove();
                    
                    // Ajouter le message d'impossibilit√© d'annulation
                    const warningMessage = document.createElement('div');
                    warningMessage.className = 'mt-2';
                    warningMessage.innerHTML = '<small class="text-warning">‚ö†Ô∏è Impossible d\'annuler: un livreur a √©t√© assign√©</small>';
                    orderElement.querySelector('.card-body').appendChild(warningMessage);
                }
            }
        }
        
        // Connexion aux √©v√©nements temps r√©el
        function connectToEvents() {
            eventSource = new EventSource('/events');
            
            eventSource.onopen = function() {
                document.getElementById('connectionStatus').textContent = 'üü¢ Connect√©';
                document.getElementById('connectionStatus').className = 'navbar-text me-3 text-success';
            };
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('√âv√©nement re√ßu:', data);
                
                switch(data.type) {
                    case 'order_ready':
                        showNotification(`üè™ Commande #${data.data.order_id} est pr√™te!`, 'info');
                        break;
                    case 'driver_assigned':
                        showNotification(`üö¥ Livreur assign√© √† la commande #${data.data.order_id}`, 'info');
                        updateOrderStatus(data.data.order_id, 'assigned');
                        break;
                    case 'auto_assignment':
                        showNotification(`ü§ñ Livreur automatiquement assign√© √† la commande #${data.data.order_id}`, 'info');
                        updateOrderStatus(data.data.order_id, 'assigned');
                        break;
                    case 'order_delivered':
                        showNotification(`‚úÖ Commande #${data.data.order_id} livr√©e!`, 'success');
                        updateOrderStatus(data.data.order_id, 'delivered');
                        break;
                    case 'order_cancelled':
                        if (data.data.client === '{{ username }}') {
                            showNotification(`‚ùå Votre commande #${data.data.order_id} a √©t√© annul√©e`, 'warning');
                            updateOrderStatus(data.data.order_id, 'cancelled');
                        }
                        break;
                }
            };
            
            eventSource.onerror = function(event) {
                document.getElementById('connectionStatus').textContent = 'üî¥ D√©connect√©';
                document.getElementById('connectionStatus').className = 'navbar-text me-3 text-danger';
                
                console.log('Erreur SSE, reconnexion...');
                setTimeout(connectToEvents, 5000);
            };
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.getElementById('notificationContainer').appendChild(notification);
            
            // Auto-supprimer apr√®s 5 secondes
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Initialisation
        connectToEvents();
        
        // Nettoyer √† la fermeture de la page
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
        
        // Rafra√Æchissement manuel toutes les 2 minutes pour synchronisation
        setInterval(() => {
            fetch('/dashboard')
                .then(response => response.text())
                .then(html => {
                    // Mettre √† jour seulement si n√©cessaire
                    const currentOrderCount = document.querySelectorAll('#ordersList .card').length;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newOrderCount = doc.querySelectorAll('#ordersList .card').length;
                    
                    if (currentOrderCount !== newOrderCount) {
                        location.reload();
                    }
                });
        }, 120000); // 2 minutes
    </script>
</body>
</html>
